name: AI Pipeline CI

on:
  workflow_dispatch:
    inputs:
      requirement:
        description: '用户需求描述'
        required: true
        type: string
  push:
    branches:
      - 'ai-generated'
      - 'main'
  pull_request:
    branches:
      - 'main'

jobs:
  test-example-app:
    name: 测试示例应用
    runs-on: ubuntu-latest

    steps:
      - name: Checkout 代码
        uses: actions/checkout@v3

      - name: 设置 Python 环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 运行 Linter (Flake8)
        run: |
          pip install flake8
          flake8 example_app/ orchestrator/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 example_app/ orchestrator/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        continue-on-error: true

      - name: 运行单元测试
        run: |
          pytest example_app/tests/ -v --tb=short
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: 生成测试覆盖率报告
        run: |
          pip install pytest-cov
          pytest example_app/tests/ --cov=example_app --cov-report=xml --cov-report=html
        continue-on-error: true

      - name: 上传覆盖率报告
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: coverage-report
          path: htmlcov/

  run-ai-pipeline:
    name: 运行 AI 流水线
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout 代码
        uses: actions/checkout@v3

      - name: 设置 Python 环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 运行 AI 流水线
        run: |
          python orchestrator/orchestrator.py --requirement "${{ github.event.inputs.requirement }}"
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          LLM_PROVIDER: ${{ secrets.LLM_PROVIDER || 'openai' }}
          AUTO_GIT_COMMIT: false

      - name: 上传生成的代码
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: generated-code
          path: /tmp/ai_pipeline_output/

  docker-build:
    name: 构建 Docker 镜像
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/ai-generated'

    steps:
      - name: Checkout 代码
        uses: actions/checkout@v3

      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: 登录 Docker Hub (可选)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
        continue-on-error: true

      - name: 构建 Docker 镜像
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: ai-pipeline:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: 测试 Docker 镜像
        run: |
          docker images
          docker run --rm ai-pipeline:latest python --version
